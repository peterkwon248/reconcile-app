import streamlit as st
import pandas as pd
import io
from openpyxl.styles import PatternFill, Font
from openpyxl import load_workbook

st.set_page_config(page_title="üìä ÏûêÎèô Ï†ïÏÇ∞ ÌîÑÎ°úÍ∑∏Îû®", layout="centered")
st.title("üìä Î™ÖÏÑ∏ÏÑú ÏûêÎèô Ï†ïÏÇ∞ ÌîÑÎ°úÍ∑∏Îû®")

st.markdown("### üì• ÏÇ¨Ïù¥Ìä∏ Ï£ºÎ¨∏ÎÇ¥Ïó≠ ÏóëÏÖÄ ÏóÖÎ°úÎìú")
order_file = st.file_uploader("", type=["xls", "xlsx"], key="order", label_visibility="collapsed")

st.markdown("### üí∞ Í≥ÑÏ¢å ÏûÖÍ∏àÎÇ¥Ïó≠ ÏóëÏÖÄ ÏóÖÎ°úÎìú")
deposit_file = st.file_uploader("", type=["xls", "xlsx"], key="deposit", label_visibility="collapsed")

if order_file and deposit_file:
    try:
        # ‚úÖ Ï£ºÎ¨∏ÎÇ¥Ïó≠ Ï≤òÎ¶¨
        order_tables = pd.read_html(order_file)
        order_df = order_tables[0]
        order_df.columns = order_df.iloc[0]
        order_df = order_df[1:]

        order_df = order_df.rename(columns={
            order_df.columns[1]: "Ï£ºÎ¨∏Ïûê",
            order_df.columns[5]: "Ï¥ù Í≤∞Ï†ú Í∏àÏï°",
            "ÏûÖÍ∏àÏûê": "ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)"
        })
        order_df["Ï¥ù Íµ¨Îß§Í∏àÏï°"] = pd.to_numeric(order_df["Ï¥ù Í≤∞Ï†ú Í∏àÏï°"], errors="coerce")
        order_df["ÏûÖÍ∏àÏûêÌÇ§"] = order_df["ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)"].astype(str).str.replace(" ", "").str.strip()

        order_grouped = order_df.groupby("ÏûÖÍ∏àÏûêÌÇ§", as_index=False).agg({
            "Ï£ºÎ¨∏Ïûê": "first",
            "ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)": "first",
            "Ï¥ù Íµ¨Îß§Í∏àÏï°": "sum"
        })

        # ‚úÖ ÏûÖÍ∏àÎÇ¥Ïó≠ Ï≤òÎ¶¨
        deposit_df = pd.read_excel(deposit_file)
        deposit_df = deposit_df.rename(columns={"ÎÇ¥Ïö©": "ÏûÖÍ∏àÏûê(Ïã§Ï†ú)", "ÏûÖÍ∏àÏï°": "ÌÜµÏû•ÏûÖÍ∏à"})
        deposit_df["ÌÜµÏû•ÏûÖÍ∏à"] = pd.to_numeric(deposit_df["ÌÜµÏû•ÏûÖÍ∏à"], errors="coerce")
        deposit_df["ÏûÖÍ∏àÏûêÌÇ§"] = deposit_df["ÏûÖÍ∏àÏûê(Ïã§Ï†ú)"].astype(str).str.replace(" ", "").str.strip()

        deposit_grouped = deposit_df.groupby("ÏûÖÍ∏àÏûêÌÇ§", as_index=False).agg({
            "ÏûÖÍ∏àÏûê(Ïã§Ï†ú)": "first",
            "ÌÜµÏû•ÏûÖÍ∏à": "sum"
        })

        # ‚úÖ Î≥ëÌï©
        matched_rows = []
        used_deposit_keys = set()

        for _, order_row in order_grouped.iterrows():
            site_key = order_row["ÏûÖÍ∏àÏûêÌÇ§"]
            matched = False

            for _, deposit_row in deposit_grouped.iterrows():
                deposit_key = deposit_row["ÏûÖÍ∏àÏûêÌÇ§"]
                if (site_key in deposit_key or deposit_key in site_key) and deposit_key not in used_deposit_keys:
                    matched_rows.append({
                        "Ï£ºÎ¨∏Ïûê": order_row["Ï£ºÎ¨∏Ïûê"],
                        "ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)": order_row["ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)"],
                        "ÏûÖÍ∏àÏûê(Ïã§Ï†ú)": deposit_row["ÏûÖÍ∏àÏûê(Ïã§Ï†ú)"],
                        "Ï¥ù Íµ¨Îß§Í∏àÏï°": order_row["Ï¥ù Íµ¨Îß§Í∏àÏï°"],
                        "ÌÜµÏû•ÏûÖÍ∏à": deposit_row["ÌÜµÏû•ÏûÖÍ∏à"]
                    })
                    used_deposit_keys.add(deposit_key)
                    matched = True
                    break

            if not matched:
                matched_rows.append({
                    "Ï£ºÎ¨∏Ïûê": order_row["Ï£ºÎ¨∏Ïûê"],
                    "ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)": order_row["ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)"],
                    "ÏûÖÍ∏àÏûê(Ïã§Ï†ú)": "",
                    "Ï¥ù Íµ¨Îß§Í∏àÏï°": order_row["Ï¥ù Íµ¨Îß§Í∏àÏï°"],
                    "ÌÜµÏû•ÏûÖÍ∏à": 0
                })

        unmatched_deposits = deposit_grouped[~deposit_grouped["ÏûÖÍ∏àÏûêÌÇ§"].isin(used_deposit_keys)]
        for _, row in unmatched_deposits.iterrows():
            matched_rows.append({
                "Ï£ºÎ¨∏Ïûê": "",
                "ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)": "",
                "ÏûÖÍ∏àÏûê(Ïã§Ï†ú)": row["ÏûÖÍ∏àÏûê(Ïã§Ï†ú)"],
                "Ï¥ù Íµ¨Îß§Í∏àÏï°": 0,
                "ÌÜµÏû•ÏûÖÍ∏à": row["ÌÜµÏû•ÏûÖÍ∏à"]
            })

        # ‚úÖ Ï†ïÎ¶¨
        result_df = pd.DataFrame(matched_rows)
        result_df["Ï∞®Ïù¥"] = result_df["ÌÜµÏû•ÏûÖÍ∏à"] - result_df["Ï¥ù Íµ¨Îß§Í∏àÏï°"]
        result_df = result_df[["Ï£ºÎ¨∏Ïûê", "ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)", "ÏûÖÍ∏àÏûê(Ïã§Ï†ú)", "Ï¥ù Íµ¨Îß§Í∏àÏï°", "ÌÜµÏû•ÏûÖÍ∏à", "Ï∞®Ïù¥"]].sort_values(by="Ï£ºÎ¨∏Ïûê")

        df_b2b = result_df[~((result_df["Ï£ºÎ¨∏Ïûê"] == "") & (result_df["ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)"] == ""))].copy()
        df_non_b2b = result_df[(result_df["Ï£ºÎ¨∏Ïûê"] == "") & (result_df["ÏûÖÍ∏àÏûê(ÏÇ¨Ïù¥Ìä∏)"] == "")].copy()
        df_more_paid = df_b2b[df_b2b["Ï∞®Ïù¥"] > 0].copy()
        df_less_paid = df_b2b[df_b2b["Ï∞®Ïù¥"] < 0].copy()

        # ‚úÖ Streamlit ÌëúÏãú
        st.success("‚úÖ Ï†ïÏÇ∞ÌëúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!")
        st.dataframe(result_df, use_container_width=True)

        # ‚úÖ ÏóëÏÖÄ Ï∂úÎ†•
        towrite = io.BytesIO()
        with pd.ExcelWriter(towrite, engine="openpyxl") as writer:
            df_b2b.to_excel(writer, index=False, sheet_name="B2B")
            df_non_b2b.to_excel(writer, index=False, sheet_name="B2B Ïù¥Ïô∏")
            df_more_paid.to_excel(writer, index=False, sheet_name="B2B_Îçî ÏûÖÍ∏àÎêú Í±¥Îì§")
            df_less_paid.to_excel(writer, index=False, sheet_name="B2B_Îçú ÏûÖÍ∏àÎêú Í±¥Îì§")

            workbook = writer.book
            yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
            red_font = Font(color="FF0000", bold=True)
            bold_font = Font(bold=True)

            for sheet_name in workbook.sheetnames:
                sheet = workbook[sheet_name]

                for row in sheet.iter_rows(min_row=2, max_row=sheet.max_row):
                    diff = row[5].value  # 'Ï∞®Ïù¥' Ïó¥
                    if diff is None:
                        continue

                    # Ï£ºÎ¨∏Ïûê(AÏó¥)Îßå ÍµµÍ≤å
                    if sheet_name in ["B2B_Îçî ÏûÖÍ∏àÎêú Í±¥Îì§", "B2B_Îçú ÏûÖÍ∏àÎêú Í±¥Îì§"]:
                        row[0].font = bold_font

                    # Ï∞®Ïù¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ
                    if diff > 0:
                        row[5].fill = yellow_fill
                        row[5].font = bold_font
                    elif diff < 0:
                        row[5].font = red_font

        st.download_button("üì• Ï†ïÏÇ∞ Í≤∞Í≥º Îã§Ïö¥Î°úÎìú", towrite.getvalue(), file_name="Ï†ïÏÇ∞Í≤∞Í≥º(Í∞ïÏ°∞ÏôÑÎ£å).xlsx")

    except Exception as e:
        st.error(f"‚ùå Ïò§Î•ò Î∞úÏÉù: {e}")
